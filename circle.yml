version: 2.1
orbs:
  cypress: cypress-io/cypress@1
workflows:
  build:
    jobs:
      - cypress/install:
          pre-steps:
            - checkout
            - setup_remote_docker
            - run:
                name: Install Docker Compose
                command: |
                  curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
                  chmod +x ~/docker-compose
                  mv ~/docker-compose /usr/local/bin/docker-compose
            - run:
                name: "Pull Submodules"
                command: |
                  git submodule init
                  git submodule update --remote
            - run:
                name: Build the REDCap image
                command: |
                    cd redcap-docker-compose/rdc
                    docker-compose up -d
            - run:
                name: Run Cypress tests
                command: |
                    cd /root/project
                    mv cypress.json.example cypress.json
                    npx cypress run